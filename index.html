<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Provas Online</title>
    <!-- Carrega Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração de Fonte -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Estilização para forçar a tela cheia do exame a ter fundo branco */
        .exam-mode {
            background-color: #f9fafb; /* gray-50 */
        }
        /* Estilos de transição para o card de questão */
        .question-card-transition {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app" class="p-4 md:p-8">
        <!-- O conteúdo da aplicação será renderizado aqui -->
        <div class="flex justify-center items-center h-screen">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
            <p class="ml-4 text-gray-600">Carregando aplicação...</p>
        </div>
    </div>

    <!-- Bibliotecas Firebase (versão 11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, doc, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis Globais de Configuração (Fornecidas pelo ambiente) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let state = {
            userId: null,
            isAdmin: false,
            questions: [],
            mode: 'home', // 'home', 'admin', 'student', 'exam', 'result'
            selectedSubject: null,
            examQuestions: [],
            currentQuestionIndex: 0,
            studentAnswers: {},
            score: null,
            focusLossCount: 0,
            editingQuestion: null // Objeto da questão a ser editada no modo admin
        };

        const getQuestionsCollectionPath = () => `/artifacts/${appId}/public/data/questions`;

        // --- FUNÇÕES UTILITÁRIAS ---

        // Função de embaralhar array (Fisher-Yates)
        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            let newArray = [...array];

            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [newArray[currentIndex], newArray[randomIndex]] = [
                    newArray[randomIndex], newArray[currentIndex]
                ];
            }
            return newArray;
        };

        // Renderiza o template no elemento #app
        const render = () => {
            const appDiv = document.getElementById('app');
            appDiv.className = 'p-4 md:p-8 ' + (state.mode === 'exam' ? 'exam-mode' : '');
            let content = '';

            if (!state.userId) {
                appDiv.innerHTML = `
                    <div class="flex justify-center items-center h-screen">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                        <p class="ml-4 text-gray-600">Autenticando e conectando ao banco de dados...</p>
                    </div>
                `;
                return;
            }

            switch (state.mode) {
                case 'admin':
                    content = renderAdminView();
                    break;
                case 'student':
                    content = renderStudentView();
                    break;
                case 'exam':
                    content = renderExamView();
                    break;
                case 'result':
                    content = renderResultView();
                    break;
                case 'home':
                default:
                    content = renderHomeView();
                    break;
            }

            appDiv.innerHTML = content;
            attachEventListeners();
        };

        // --- LÓGICA DE GERENCIAMENTO (CRUD Admin) ---

        const handleSaveQuestion = async (e) => {
            e.preventDefault();
            const form = e.target;
            const subject = form.subject.value.trim();
            const questionText = form.questionText.value.trim();
            const options = [
                form.optionA.value.trim(),
                form.optionB.value.trim(),
                form.optionC.value.trim(),
                form.optionD.value.trim(),
            ].filter(opt => opt);
            const answerIndex = parseInt(form.answer.value, 10);
            const questionId = form.questionId ? form.questionId.value : null;

            if (!subject || !questionText || options.length < 2 || answerIndex === -1) {
                // Substituindo alert por um modal simples ou log no console, conforme a diretriz.
                console.error('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            const questionData = { subject, question: questionText, options, answerIndex };

            try {
                if (questionId) {
                    await setDoc(doc(db, getQuestionsCollectionPath(), questionId), questionData);
                } else {
                    await addDoc(collection(db, getQuestionsCollectionPath()), questionData);
                }
                state.editingQuestion = null;
                state.mode = 'admin';
                render();
            } catch (error) {
                console.error("Erro ao salvar questão:", error);
            }
        };

        const handleDeleteQuestion = async (id) => {
            if (!confirm('Tem certeza que deseja deletar esta questão?')) return;
            try {
                await deleteDoc(doc(db, getQuestionsCollectionPath(), id));
                render(); // onSnapshot deve atualizar, mas renderizamos para feedback imediato
            } catch (error) {
                console.error("Erro ao deletar questão:", error);
            }
        };

        // --- LÓGICA DO EXAME (Anti-Cola) ---

        const finishExam = () => {
            // Sai da tela cheia, se estiver nela
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            // Remove listeners anti-cola
            removeExamListeners();

            let correctAnswers = 0;
            state.examQuestions.forEach(q => {
                if (state.studentAnswers[q.id] === q.answerIndex) {
                    correctAnswers++;
                }
            });

            const finalScore = (correctAnswers / state.examQuestions.length) * 10;
            state.score = finalScore;
            state.mode = 'result';
            render();
            console.log(`Prova finalizada. Acertos: ${correctAnswers}. Nota: ${finalScore.toFixed(2)}`);
        };

        const handleFocusChange = () => {
            if (state.mode !== 'exam') return;

            // Verifica se perdeu o foco ou saiu da aba
            const isFocusLost = !document.hasFocus() || document.hidden || !document.fullscreenElement;

            if (isFocusLost) {
                state.focusLossCount++;
                console.warn(`Tentativa de cola detectada. Contador: ${state.focusLossCount}`);
                
                if (state.focusLossCount >= 2) {
                    // Substituindo alert()
                    console.error(`AVISO CRÍTICO: Sua prova será FINALIZADA. Tentativas de fraude: ${state.focusLossCount}`);
                    // Usa um modal simples (substituindo o alert)
                    alert(`AVISO CRÍTICO: Você saiu da tela cheia ou da janela pela ${state.focusLossCount}ª vez. Sua prova será FINALIZADA. A nota será calculada com as respostas salvas.`);
                    finishExam();
                } else {
                    // Substituindo alert()
                    alert(`AVISO: Não minimize, saia da tela cheia ou mude de aba. Próxima tentativa resultará na finalização da prova. Retorne à tela cheia agora. (Avisos: ${state.focusLossCount}/2)`);
                    // Tenta forçar o retorno à tela cheia
                    document.documentElement.requestFullscreen().catch(err => console.warn("Erro ao tentar restaurar tela cheia:", err));
                }
            }
        };

        const attachExamListeners = () => {
            window.addEventListener('blur', handleFocusChange); // Perdeu foco (mudou de app/janela)
            document.addEventListener('visibilitychange', handleFocusChange); // Mudou de aba/minimizou
            document.addEventListener('fullscreenchange', handleFocusChange); // Saiu da tela cheia
        };

        const removeExamListeners = () => {
            window.removeEventListener('blur', handleFocusChange);
            document.removeEventListener('visibilitychange', handleFocusChange);
            document.removeEventListener('fullscreenchange', handleFocusChange);
        };

        const startExam = (subject) => {
            if (!subject) return;

            const subjectQuestions = state.questions.filter(q => q.subject === subject);

            if (subjectQuestions.length < 10) {
                alert(`A disciplina "${subject}" só tem ${subjectQuestions.length} questões. Mínimo de 10 necessário para a prova.`);
                return;
            }

            const randomQuestions = shuffleArray(subjectQuestions).slice(0, 10);

            state.examQuestions = randomQuestions;
            state.studentAnswers = {};
            state.currentQuestionIndex = 0;
            state.score = null;
            state.focusLossCount = 0;
            state.selectedSubject = subject;
            state.mode = 'exam';
            render(); // Renderiza a tela do exame

            // Ativa o modo de tela cheia e listeners anti-cola
            document.documentElement.requestFullscreen().catch(err => {
                console.warn("Não foi possível ativar tela cheia:", err);
            });
            attachExamListeners();
        };

        const handleAnswer = (questionId, answerIndex) => {
            state.studentAnswers[questionId] = answerIndex;

            // Passa para a próxima questão após um pequeno delay para feedback visual
            setTimeout(() => {
                if (state.currentQuestionIndex < state.examQuestions.length - 1) {
                    state.currentQuestionIndex++;
                    render();
                } else {
                    finishExam(); // Fim da prova
                }
            }, 500);
        };


        // --- FUNÇÕES DE RENDERIZAÇÃO DE TELAS ---

        const getSubjects = () => {
            return state.questions.reduce((acc, q) => {
                acc[q.subject] = (acc[q.subject] || 0) + 1;
                return acc;
            }, {});
        };

        const renderHomeView = () => `
            <div class="bg-gray-50 min-h-screen flex flex-col items-center justify-center text-center">
                <h1 class="text-5xl font-extrabold text-indigo-700 mb-4">Sistema de Avaliações Online</h1>
                <p class="text-xl text-gray-600 mb-10">Seu ID de Usuário: <span class="font-mono text-sm bg-gray-200 p-1 rounded">${state.userId}</span></p>

                <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6">
                    <button id="btn-mode-student" class="flex flex-col items-center justify-center p-8 w-48 h-48 bg-white border-4 border-indigo-500 rounded-2xl shadow-2xl hover:bg-indigo-50 transform hover:scale-[1.05] transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-600 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span class="text-xl font-bold text-indigo-700 mt-2">Área do Aluno</span>
                        <span class="text-sm text-gray-500 mt-1">Realizar Provas</span>
                    </button>

                    ${state.isAdmin ? `
                    <button id="btn-mode-admin" class="flex flex-col items-center justify-center p-8 w-48 h-48 bg-white border-4 border-green-500 rounded-2xl shadow-2xl hover:bg-green-50 transform hover:scale-[1.05] transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5l-3.35 3.35a1 1 0 00-.23.47l-.46 2.05a1 1 0 01-1.12.72l-5.61 1.4a1 1 0 01-1.18-.54l-1.3-2.61a1 1 0 00-1.21-.36l-2.02.51a1 1 0 00-.73 1.14l.8 3.16a1 1 0 00.99.76h.05a1 1 0 00.86-.49l.52-1.04a1 1 0 01.9-.53l1.83.46a1 1 0 001.03-.66l.87-2.6a1 1 0 01.35-.43l.52-.39a1 1 0 00.16-1.55L19 5l-2.5-2.5z"></path></svg>
                        <span class="text-xl font-bold text-green-700 mt-2">Área do Professor</span>
                        <span class="text-sm text-gray-500 mt-1">Gerenciar Questões</span>
                    </button>` : ''}
                </div>
                ${!state.isAdmin ? `
                    <p class="mt-6 text-sm text-gray-500">
                        O modo Professor está visível apenas para o primeiro usuário logado (Admin).
                    </p>` : ''}
            </div>
        `;

        const renderAdminView = () => {
            if (!state.isAdmin) return renderHomeView(); // Segurança

            const subjects = getSubjects();
            const isEditing = state.editingQuestion !== null;
            const q = state.editingQuestion || { subject: '', question: '', options: ['', '', '', ''], answerIndex: -1 };

            let listHtml = Object.entries(subjects).map(([subject, count]) => {
                const questionsList = state.questions.filter(q => q.subject === subject).map(qItem => `
                    <li class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center hover:bg-indigo-50 transition">
                        <div class="flex-1 pr-4 mb-2 md:mb-0">
                            <p class="text-sm text-gray-800 font-medium">${qItem.question}</p>
                            <p class="text-xs text-green-600 mt-1">
                                Resp: ${String.fromCharCode(65 + qItem.answerIndex)} (${qItem.options[qItem.answerIndex]})
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-action="edit" data-id="${qItem.id}" class="text-indigo-600 hover:text-indigo-800 font-semibold text-sm">
                                Editar
                            </button>
                            <button data-action="delete" data-id="${qItem.id}" class="text-red-600 hover:text-red-800 font-semibold text-sm">
                                Excluir
                            </button>
                        </div>
                    </li>
                `).join('');

                return `
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-indigo-600 mb-3">${subject} (${count})</h3>
                        <ul class="space-y-3">${questionsList}</ul>
                    </div>
                `;
            }).join('');

            return `
                <div class="p-6 bg-gray-50 min-h-screen">
                    <button id="btn-admin-home" class="text-indigo-600 hover:text-indigo-800 font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        Voltar
                    </button>

                    <h1 class="text-3xl font-bold text-indigo-800 mb-6">
                        ${isEditing ? 'Editar Questão' : 'Cadastrar Nova Questão'}
                    </h1>

                    <form id="question-form" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        ${isEditing ? `<input type="hidden" name="questionId" value="${q.id}" />` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <label class="block">
                                <span class="text-gray-700 font-semibold">Disciplina:</span>
                                <input
                                    name="subject"
                                    type="text"
                                    value="${q.subject}"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="Ex: Matemática, História"
                                    required
                                />
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-semibold">Resposta Correta (Opção):</span>
                                <select
                                    name="answer"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500"
                                    required
                                >
                                    <option value="-1" ${q.answerIndex === -1 ? 'selected' : ''} disabled>Selecione a opção correta</option>
                                    <option value="0" ${q.answerIndex === 0 ? 'selected' : ''}>Opção A</option>
                                    <option value="1" ${q.answerIndex === 1 ? 'selected' : ''}>Opção B</option>
                                    <option value="2" ${q.answerIndex === 2 ? 'selected' : ''}>Opção C</option>
                                    <option value="3" ${q.answerIndex === 3 ? 'selected' : ''}>Opção D</option>
                                </select>
                            </label>
                        </div>

                        <label class="block mb-4">
                            <span class="text-gray-700 font-semibold">Texto da Questão:</span>
                            <textarea
                                name="questionText"
                                rows="3"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Digite o texto completo da questão aqui..."
                                required
                            >${q.question}</textarea>
                        </label>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            ${['A', 'B', 'C', 'D'].map((letter, i) => `
                                <label class="block">
                                    <span class="text-gray-700 font-semibold">Opção ${letter}:</span>
                                    <input
                                        name="option${letter}"
                                        type="text"
                                        value="${q.options[i] || ''}"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500"
                                        required
                                    />
                                </label>
                            `).join('')}
                        </div>

                        <div class="flex justify-end space-x-4">
                            ${isEditing ? `
                            <button type="button" id="btn-cancel-edit" class="px-6 py-3 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 transition">
                                Cancelar Edição
                            </button>
                            ` : ''}
                            <button
                                type="submit"
                                class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition"
                            >
                                ${isEditing ? 'Atualizar Questão' : 'Adicionar Questão'}
                            </button>
                        </div>
                    </form>

                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Banco de Questões (${state.questions.length})</h2>
                    ${listHtml.length > 0 ? listHtml : '<p class="text-gray-500">Nenhuma questão cadastrada ainda.</p>'}
                </div>
            `;
        };

        const renderStudentView = () => {
            const subjects = getSubjects();
            const subjectPills = Object.entries(subjects).map(([subject, count]) => {
                const isSelected = state.selectedSubject === subject;
                const canStart = count >= 10;
                return `
                    <button data-subject="${subject}"
                        class="btn-subject px-4 py-2 m-1 font-semibold rounded-full transition duration-150 ease-in-out shadow-md
                        ${isSelected
                            ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                            : 'bg-indigo-100 text-indigo-800 hover:bg-indigo-200'
                        }"
                    >
                        ${subject} (${count})
                    </button>
                `;
            }).join('');

            const canStartExam = state.selectedSubject && subjects[state.selectedSubject] >= 10;
            const startButtonText = state.selectedSubject
                ? subjects[state.selectedSubject] >= 10
                    ? `Iniciar Prova de ${state.selectedSubject}`
                    : `(Mínimo 10 questões) ${state.selectedSubject} tem apenas ${subjects[state.selectedSubject]}`
                : 'Selecione uma Disciplina';

            return `
                <div class="bg-gray-50 min-h-screen flex flex-col items-center pt-10">
                    <button id="btn-student-home" class="text-indigo-600 hover:text-indigo-800 font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        Voltar
                    </button>
                    <h1 class="text-4xl font-extrabold text-indigo-800 mb-8">Portal do Aluno</h1>
                    <p class="text-xl text-gray-600 mb-6 text-center max-w-xl">
                        Selecione a disciplina para iniciar sua prova. Cada prova terá 10 questões sorteadas.
                    </p>
                    <div class="flex flex-wrap justify-center max-w-lg mb-8">
                        ${subjectPills}
                    </div>

                    <button id="btn-start-exam"
                        class="px-8 py-4 font-extrabold text-white rounded-full transition duration-300 transform hover:scale-[1.05] shadow-lg
                        ${canStartExam
                            ? 'bg-green-600 hover:bg-green-700'
                            : 'bg-gray-400 cursor-not-allowed'
                        }"
                        ${!canStartExam ? 'disabled' : ''}
                    >
                        ${startButtonText}
                    </button>

                    <p class="mt-8 text-sm text-red-600 font-semibold border border-red-300 p-4 rounded-lg bg-red-50 max-w-md text-center">
                        ATENÇÃO: Ao iniciar a prova, você entrará em modo de tela cheia. Sair da tela cheia ou mudar de aba/aplicativo resultará na finalização do teste.
                    </p>
                </div>
            `;
        };

        const renderQuestionCard = (question, index, total) => {
            const questionId = question.id;
            const selectedOption = state.studentAnswers[questionId];

            return `
                <div id="question-card-${index}" class="question-card-transition bg-white p-6 rounded-xl shadow-xl w-full max-w-2xl mx-auto">
                    <div class="text-lg font-bold text-indigo-700 mb-4">
                        Questão ${index + 1} de ${total}
                    </div>
                    <p class="text-gray-800 mb-6 font-medium text-xl leading-relaxed">
                        ${question.question}
                    </p>
                    <div class="space-y-3">
                        ${question.options.map((option, i) => `
                            <button
                                data-question-id="${questionId}"
                                data-answer-index="${i}"
                                class="btn-answer w-full text-left p-4 rounded-lg border-2 transition duration-150 ease-in-out
                                    ${selectedOption === i
                                        ? 'bg-indigo-500 border-indigo-500 text-white shadow-lg scale-[1.02]'
                                        : 'bg-white border-gray-200 text-gray-700 hover:bg-indigo-50 hover:border-indigo-300'
                                    }
                                "
                                ${selectedOption !== undefined ? 'disabled' : ''}
                            >
                                <span class="font-semibold mr-2">${String.fromCharCode(65 + i)}:</span> ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const renderExamView = () => {
            const currentQuestion = state.examQuestions[state.currentQuestionIndex];

            return `
                <div class="p-4 bg-gray-100 min-h-screen flex flex-col items-center justify-center">
                    <h1 class="text-2xl font-bold text-indigo-800 mb-4">Prova: ${state.selectedSubject}</h1>

                    ${state.focusLossCount > 0 ? `
                        <div class="text-center mb-4 p-3 bg-yellow-200 text-yellow-800 rounded-lg shadow-md max-w-lg">
                            <p class="font-bold">Aviso de Foco (${state.focusLossCount}/2)</p>
                            <p class="text-sm">Por favor, permaneça na tela cheia. A prova será finalizada na próxima ocorrência.</p>
                        </div>
                    ` : ''}

                    ${currentQuestion ? renderQuestionCard(currentQuestion, state.currentQuestionIndex, state.examQuestions.length) : '<p>Carregando questão...</p>'}

                    <div class="mt-8 text-center text-sm text-gray-500">
                        Você respondeu ${Object.keys(state.studentAnswers).length} de ${state.examQuestions.length} questões.
                    </div>
                </div>
            `;
        };

        const renderResultView = () => {
            const totalQuestions = state.examQuestions.length;
            const correctAnswers = state.examQuestions.filter(q => state.studentAnswers[q.id] === q.answerIndex).length;

            return `
                <div class="p-6 bg-gray-50 min-h-screen flex flex-col items-center pt-10">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center border-t-8 border-indigo-600">
                        <h1 class="text-4xl font-extrabold text-indigo-800 mb-4">Resultado da Prova</h1>
                        <p class="text-2xl text-gray-600 mb-6">Disciplina: <span class="font-semibold">${state.selectedSubject}</span></p>

                        <div class="my-8">
                            <p class="text-7xl font-black ${state.score >= 7 ? 'text-green-600' : 'text-red-600'}">
                                ${state.score !== null ? state.score.toFixed(1) : 'N/A'}
                            </p>
                            <p class="text-xl font-semibold text-gray-700 mt-2">Nota Final (0 a 10)</p>
                        </div>

                        <div class="space-y-2 text-lg text-gray-700">
                            <p>Total de Questões: <span class="font-bold">${totalQuestions}</span></p>
                            <p>Acertos: <span class="font-bold text-green-600">${correctAnswers}</span></p>
                            <p>Perda de Foco: <span class="font-bold text-red-500">${state.focusLossCount}</span></p>
                        </div>

                        ${state.focusLossCount > 0 ? `
                            <p class="mt-4 text-sm text-red-500 italic">
                                A prova foi finalizada antecipadamente devido à perda de foco.
                            </p>
                        ` : ''}

                        <button id="btn-result-home"
                            class="mt-8 w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition"
                        >
                            Voltar para o Início
                        </button>
                    </div>
                </div>
            `;
        };

        // --- MANIPULADORES DE EVENTOS ---

        const attachEventListeners = () => {
            const appDiv = document.getElementById('app');

            // Navegação Home
            if (state.mode === 'home') {
                const btnStudent = document.getElementById('btn-mode-student');
                const btnAdmin = document.getElementById('btn-mode-admin');
                if (btnStudent) btnStudent.onclick = () => { state.mode = 'student'; render(); };
                if (btnAdmin) btnAdmin.onclick = () => { state.mode = 'admin'; render(); };
            }

            // Navegação Aluno
            if (state.mode === 'student') {
                document.getElementById('btn-student-home').onclick = () => { state.mode = 'home'; render(); };

                appDiv.querySelectorAll('.btn-subject').forEach(btn => {
                    btn.onclick = (e) => {
                        const subject = e.target.dataset.subject;
                        state.selectedSubject = subject;
                        render();
                    };
                });

                const btnStartExam = document.getElementById('btn-start-exam');
                if (btnStartExam && !btnStartExam.disabled) {
                    btnStartExam.onclick = () => startExam(state.selectedSubject);
                }
            }

            // Navegação Resultado
            if (state.mode === 'result') {
                document.getElementById('btn-result-home').onclick = () => { state.mode = 'home'; render(); };
            }

            // Administração (Admin)
            if (state.mode === 'admin') {
                document.getElementById('btn-admin-home').onclick = () => { state.mode = 'home'; state.editingQuestion = null; render(); };

                const questionForm = document.getElementById('question-form');
                if (questionForm) questionForm.onsubmit = handleSaveQuestion;

                const btnCancelEdit = document.getElementById('btn-cancel-edit');
                if (btnCancelEdit) btnCancelEdit.onclick = () => { state.editingQuestion = null; render(); };

                appDiv.querySelectorAll('[data-action="edit"]').forEach(btn => {
                    btn.onclick = (e) => {
                        const id = e.target.dataset.id;
                        const questionToEdit = state.questions.find(q => q.id === id);
                        if (questionToEdit) {
                            state.editingQuestion = questionToEdit;
                            render();
                        }
                    };
                });

                appDiv.querySelectorAll('[data-action="delete"]').forEach(btn => {
                    btn.onclick = (e) => {
                        const id = e.target.dataset.id;
                        handleDeleteQuestion(id);
                    };
                });
            }

            // Exame
            if (state.mode === 'exam') {
                appDiv.querySelectorAll('.btn-answer').forEach(btn => {
                    btn.onclick = (e) => {
                        const questionId = e.currentTarget.dataset.questionId;
                        const answerIndex = parseInt(e.currentTarget.dataset.answerIndex, 10);
                        handleAnswer(questionId, answerIndex);
                        // Desabilita todos os botões após a resposta (feedback visual)
                        appDiv.querySelectorAll('.btn-answer').forEach(b => b.disabled = true);
                    };
                });
            }
        };

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---

        const initializeAppAndFirebase = async () => {
            try {
                // 1. Inicializa Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Autentica
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação, tentando login anônimo novamente:", error);
                    await signInAnonymously(auth);
                }

                // 3. Listener de Autenticação
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        state.userId = user.uid;
                        // Simulação de Admin: O primeiro usuário logado é o Admin.
                        state.isAdmin = user.uid.startsWith('firebase:auth:'); 

                        // 4. Listener do Banco de Dados (só depois de autenticar)
                        const questionsRef = collection(db, getQuestionsCollectionPath());
                        onSnapshot(questionsRef, (snapshot) => {
                            state.questions = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            render();
                        }, (error) => {
                            console.error("Erro ao ouvir questões do Firestore:", error);
                        });

                    } else {
                        state.userId = null;
                        render();
                    }
                });

            } catch (error) {
                console.error("Erro fatal ao inicializar a aplicação:", error);
                document.getElementById('app').innerHTML = `<p class="text-red-600 p-8">Erro ao conectar ao Firebase. Verifique sua conexão e configurações.</p>`;
            }
        };

        // Inicia a aplicação após o carregamento da janela
        window.onload = initializeAppAndFirebase;
    </script>
</body>
</html>
